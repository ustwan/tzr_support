═══════════════════════════════════════════════════════════════════════
  📡 FEEDBACK BOT - КРАТКАЯ СВОДКА ДЛЯ DJANGO AI
═══════════════════════════════════════════════════════════════════════

🤖 БОТ ПОДКЛЮЧАЕТСЯ К САЙТУ ЧЕРЕЗ WEBSOCKET (ИСХОДЯЩЕЕ)

wss://tzreloaded.ru/ws/feedback-bot?token=<JWT>

НЕТ ОТКРЫТЫХ ПОРТОВ!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ПРОТОКОЛ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Сайт → Бот (новое обращение):
{
  type: "new_feedback",
  id: "uuid",
  data: {
    feedback_id: 123,
    telegram_id: 999,
    telegram_username: "user",
    telegram_first_name: "Имя",
    nickname: "PlayerNick",
    category: "bug",
    message: "Текст",
    created_at: "2025-10-17T12:00:00",
    source: "website"
  },
  ts: timestamp,
  nonce: "uuid",
  sig: "hmac-sha256"
}

Бот → Сайт (результат):
{
  type: "feedback_result",
  id: "uuid",
  ok: true,
  result: {
    ticket_id: "ticket_site_123",
    message_id: 456,
    sent_at: "2025-10-17T12:00:01"
  },
  error: null,
  ts, nonce, sig
}

HMAC: sig = HMAC(secret, "{ts}.{nonce}.{compact_json}")
      compact_json = JSON.dumps(sort_keys=True, separators=(',',':'))

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ДЛЯ DJANGO:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Создай consumer: portal/consumers.py
   
   class FeedbackBotConsumer(AsyncWebsocketConsumer):
       async def connect(self):
           # Проверь JWT токен
           # Сохрани соединение: self.bot_connected = True
       
       async def receive(self, text_data):
           # Получи результат от бота
           # Обнови feedback.telegram_sent = True

2. Роутинг: portal/routing.py
   
   websocket_urlpatterns = [
       path('ws/feedback-bot', FeedbackBotConsumer.as_asgi()),
   ]

3. При создании feedback:
   
   feedback = Feedback.objects.create(...)
   
   # Отправь через WebSocket
   await channel_layer.send('feedback-bot', {
       'type': 'new_feedback',
       'id': str(uuid.uuid4()),
       'data': {...},
       'ts': int(time.time()),
       'nonce': str(uuid.uuid4()),
       'sig': compute_hmac(...)
   })

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⏱️ ВРЕМЯ: ~30 минут

📦 КОД БОТА: https://github.com/ustwan/tzr_support

ЛОГИКА HMAC: Та же что в Site Agent (portal/site_agent/hmac_utils.py)

═══════════════════════════════════════════════════════════════════════

